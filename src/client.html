<!DOCTYPE html>
<html>
    <head>
      <title>Audio Streaming</title>
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <style>
        body {
          font-family: Arial, sans-serif;
          display: flex;
          flex-direction: column;
          align-items: center;
          justify-content: center;
          min-height: 100vh;
          margin: 0;
          background-color: #f0f0f0;
          padding: 20px;
          box-sizing: border-box;
        }
        h1 {
          color: #333;
          font-size: 24px;
          text-align: center;
        }
        #startButton {
          padding: 15px 30px;
          font-size: 18px;
          cursor: pointer;
          background-color: #4CAF50;
          color: white;
          border: none;
          border-radius: 5px;
          transition: background-color 0.3s;
          width: 100%;
          max-width: 300px;
        }
        #startButton:hover {
          background-color: #45a049;
        }
        #status {
          margin-top: 20px;
          font-style: italic;
          text-align: center;
        }
        @media (max-width: 480px) {
          h1 {
            font-size: 20px;
          }
          #startButton {
            font-size: 16px;
            padding: 12px 24px;
          }
        }
      </style>
    </head>
<body>
  <h1>Audio Streaming</h1>
  <button id="startButton">Start Streaming</button>
  <div id="status"></div>
  <script>
      const startButton = document.getElementById('startButton');
      const statusDiv = document.getElementById('status');
      let mediaRecorder;
      let socket;
      let isStreaming = false;
      let headerSent = false;
      let wakeLock = null

      startButton.addEventListener('click', async () => {
          if (!isStreaming) {
              try {
                  const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                  mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm;codecs=opus' });

                  socket = new WebSocket(`ws://${window.location.host}/ws`);
                  socket.onopen = () => {
                      console.log('WebSocket connected');
                      mediaRecorder.start(20);
                      startButton.textContent = 'Stop Streaming';
                      startButton.style.backgroundColor = '#f44336';
                      isStreaming = true;
                      statusDiv.textContent = 'Streaming...';
                  };

                  socket.onclose = () => {
                      console.log('WebSocket disconnected');
                      stopStreaming();
                      wakeLock?.release();
                  };

                  mediaRecorder.ondataavailable = async (event) => {
                      if (event.data.size > 0 && socket.readyState === WebSocket.OPEN) {
                          console.log(`Sending chunk of size: ${event.data.size} bytes`);
                          await socket.send(event.data);
                      }
                  };

                  try {
                    wakeLock = await navigator.wakeLock.request('screen');
                  } catch (error) {
                    console.error('Error requesting wake lock:', error);
                  }
              } catch (error) {
                  console.error('Error accessing microphone:', error);
                  statusDiv.textContent = 'Error: Unable to access microphone';
              }
          } else {
              stopStreaming();
              wakeLock?.release();
          }
      });

      function stopStreaming() {
          if (mediaRecorder) {
              mediaRecorder.stop();
          }
          if (socket) {
              socket.close();
          }
          startButton.textContent = 'Start Streaming';
          startButton.style.backgroundColor = '#4CAF50';
          isStreaming = false;
          headerSent = false;
          statusDiv.textContent = 'Streaming stopped';
      }
  </script>
</body>
</html>
